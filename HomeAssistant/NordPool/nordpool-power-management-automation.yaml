# Power Management Automation based on Nord Pool prices with transfer
# This file is suitable for !include_dir_merge_list
# Manages power consumption across all energy consumers
# Total power limit: 4.0 kW - sensor.p1mini_momentary_active_import_phase_3 provides power in kW
# Priority order: Water Heater (Priority 1) > EV Charger (Priority 2) > Bath Heater (Priority 3)

# Power consumption constants (in kW)
# Water heater: 2.3 kW (Priority 1)
# EV charger: variable, simplified on/off control (Priority 2)
# Bath heater: 0.4 kW (Priority 3)

# Automation: Power Management - Turn off lower priority devices if power limit exceeded
# This handles cases where power consumption exceeds 4 kW due to other loads
- id: power_management_turn_off_lower_priority
  alias: "Power Management - Turn OFF lower priority devices if limit exceeded"
  description: "Turns off devices in reverse priority order if total power consumption exceeds 4 kW"
  trigger:
    - platform: state
      entity_id: sensor.p1mini_momentary_active_import_phase_3
  condition:
    - condition: template
      value_template: >
        {% set power_limit = 4.0 %}
        {% set current_power = states('sensor.p1mini_momentary_active_import_phase_3') | float(0) %}
        {{ current_power > power_limit }}
  action:
    - choose:
        # Priority 3: Turn off bath heater first (lowest priority)
        - conditions:
            - condition: state
              entity_id: switch.tasmota_2
              state: "on"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.tasmota_2
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Turned OFF Bath Heater - Power limit exceeded:
                  {{ states('sensor.p1mini_momentary_active_import_phase_3') | float(0) | round(2) }} kW > 4.0 kW
                entity_id: switch.tasmota_2
        # Priority 2: Turn off EV charger
        - conditions:
            - condition: state
              entity_id: switch.ev_charger_ev_charger_switch
              state: "on"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.ev_charger_ev_charger_switch
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Turned OFF EV Charger - Power limit exceeded:
                  {{ states('sensor.p1mini_momentary_active_import_phase_3') | float(0) | round(2) }} kW > 4.0 kW
                entity_id: switch.ev_charger_ev_charger_switch
        # Priority 1: Water heater - Turn off as last resort if power limit still exceeded
        # This is a safety mechanism if something else consumes all L3 power
        - conditions:
            - condition: state
              entity_id: light.sonoff
              state: "on"
            - condition: template
              value_template: >
                {% set power_limit = 4.0 %}
                {% set current_power = states('sensor.p1mini_momentary_active_import_phase_3') | float(0) %}
                {# Turn off water heater if power is still exceeded after lower priority devices are off #}
                {# Check if bath heater and EV charger are off, or if power is critically high #}
                {% set bath_heater_off = states('switch.tasmota_2') == 'off' %}
                {% set ev_charger_off = states('switch.ev_charger_ev_charger_switch') == 'off' %}
                {{ current_power > power_limit and (bath_heater_off and ev_charger_off) }}
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.sonoff
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Turned OFF Water Heater (safety) - Power limit still exceeded:
                  {{ states('sensor.p1mini_momentary_active_import_phase_3') | float(0) | round(2) }} kW > 4.0 kW
                  (Lower priority devices already off)
                entity_id: light.sonoff
      default:
        - service: logbook.log
          data:
            name: Power Management
            message: >
              Power limit exceeded: {{ states('sensor.p1mini_momentary_active_import_phase_3') | float(0) | round(2) }} kW > 4.0 kW,
              but no devices to turn off
  mode: single

