# Power Management Automation based on Nord Pool prices with transfer
# This file is suitable for !include_dir_merge_list
# Manages current consumption across all energy consumers
# Total current limit: 17000 mA (17 A) - sensor.l3_current provides data in mA
# Priority order: Water Heater (Priority 1) > EV Charger (Priority 2) > Bath Heater (Priority 3)

# Current consumption constants (in mA, assuming 230V)
# Water heater: 10000 mA (10 A, 2.3 kW) (Priority 1)
# EV charger: variable based on current limit (Priority 2)
#   - 6A = 6000 mA, 8A = 8000 mA, 10A = 10000 mA, 13A = 13000 mA, 16A = 16000 mA
# Bath heater: ~1740 mA (1.74 A, 0.4 kW) (Priority 3)

# Automation: Power Management - Turn off lower priority devices if current limit exceeded
# This handles cases where current consumption exceeds 17 A due to other loads
- id: power_management_turn_off_lower_priority
  alias: "Power Management - Turn OFF lower priority devices if limit exceeded"
  description: "Turns off devices in reverse priority order if total current consumption exceeds 17 A"
  trigger:
    - platform: state
      entity_id: sensor.l3_current
  condition:
    - condition: template
      value_template: >
        {% set total_limit = 17000.0 %}
        {% set current_consumption = states('sensor.l3_current') | float(0) %}
        {{ current_consumption > total_limit }}
  action:
    - choose:
        # Priority 3: Turn off bath heater first (lowest priority)
        - conditions:
            - condition: state
              entity_id: switch.tasmota_2
              state: "on"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.tasmota_2
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Turned OFF Bath Heater - Current limit exceeded:
                  {{ (states('sensor.l3_current') | float(0)) | round(0) }} mA > 17000 mA ({{ ((states('sensor.l3_current') | float(0)) / 1000) | round(2) }} A > 17 A)
                entity_id: switch.tasmota_2
        # Priority 2: Reduce EV charger to minimum if possible
        - conditions:
            - condition: state
              entity_id: switch.ev_charger_ev_charger_switch
              state: "on"
            - condition: template
              value_template: >
                {% set total_limit = 17000.0 %}
                {% set current_consumption = states('sensor.l3_current') | float(0) %}
                {% set current_limit = states('number.ev_charger_ev_charger_max_current') | int(0) %}
                {# Check if we can reduce current: must be > 6A currently #}
                {# AND reducing to 6A must be enough to get under the limit (or close enough that we want to try) #}
                {# We assume reducing to 6A drops consumption by (current_limit - 6) * 1000 #}
                {% set assumed_drop = (current_limit - 6) * 1000 %}
                {% set projected_consumption = current_consumption - assumed_drop %}
                {{ current_limit > 6 and projected_consumption <= 17000 }}
          sequence:
            - service: number.set_value
              target:
                entity_id: number.ev_charger_ev_charger_max_current
              data:
                value: 6
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Reduced EV Charger to 6A - Current limit exceeded:
                  {{ (states('sensor.l3_current') | float(0)) | round(0) }} mA > 17000 mA
                  (Projected: {{ ((states('sensor.l3_current') | float(0) - (states('number.ev_charger_ev_charger_max_current') | int(0) - 6) * 1000) / 1000) | round(2) }} A)
                entity_id: switch.ev_charger_ev_charger_switch
        # Priority 2: Turn off EV charger if reducing isn't enough or already at minimum
        - conditions:
            - condition: state
              entity_id: switch.ev_charger_ev_charger_switch
              state: "on"
            # If we are here, it means we either couldn't reduce (already <= 6A) OR reducing wouldn't be enough
            # So we must turn off
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.ev_charger_ev_charger_switch
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Turned OFF EV Charger - Current limit exceeded and reducing not possible/sufficient:
                  {{ (states('sensor.l3_current') | float(0)) | round(0) }} mA > 17000 mA
                entity_id: switch.ev_charger_ev_charger_switch
        # Priority 1: Water heater - Turn off as last resort if power limit still exceeded
        # This is a safety mechanism if something else consumes all L3 power
        - conditions:
            - condition: state
              entity_id: light.sonoff
              state: "on"
            - condition: template
              value_template: >
                {% set total_limit = 17000.0 %}
                {% set current_consumption = states('sensor.l3_current') | float(0) %}
                {# Turn off water heater if current is still exceeded after lower priority devices are off #}
                {# Check if bath heater and EV charger are off, or if current is critically high #}
                {% set bath_heater_off = states('switch.tasmota_2') == 'off' %}
                {% set ev_charger_off = states('switch.ev_charger_ev_charger_switch') == 'off' %}
                {{ current_consumption > total_limit and (bath_heater_off and ev_charger_off) }}
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.sonoff
            - service: logbook.log
              data:
                name: Power Management
                message: >
                  Turned OFF Water Heater (safety) - Current limit still exceeded:
                  {{ (states('sensor.l3_current') | float(0)) | round(0) }} mA > 17000 mA ({{ ((states('sensor.l3_current') | float(0)) / 1000) | round(2) }} A > 17 A)
                  (Lower priority devices already off)
                entity_id: light.sonoff
      default:
        - service: logbook.log
          data:
            name: Power Management
            message: >
              Current limit exceeded: {{ (states('sensor.l3_current') | float(0)) | round(0) }} mA > 17000 mA ({{ ((states('sensor.l3_current') | float(0)) / 1000) | round(2) }} A > 17 A),
              but no devices to turn off
  mode: single

