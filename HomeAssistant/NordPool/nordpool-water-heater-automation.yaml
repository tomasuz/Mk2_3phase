# Water Heater Automation based on Nord Pool prices with transfer
# This file is suitable for !include_dir_merge_list
# Uses sensor.energy_price_total which provides current price with transfer
# Priority 1: Water Heater (2.3 kW)
# Total current limit: 17000 mA (17 A) - sensor.l3_current provides data in mA

# Automation: Water Heater - Turn ON when price is low and power is available
- id: water_heater_turn_on_low_price
  alias: "Water Heater - Turn ON when price < low_energy_price_cap (Priority 1)"
  description: "Turns on water heater when energy price is low and power is available (2.3 kW required)"
  trigger:
    - platform: state
      entity_id: sensor.energy_price_total
    - platform: state
      entity_id: input_number.low_energy_price_cap
    - platform: state
      entity_id: sensor.l3_current
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: switch.ev_charger_ev_charger_switch
    - platform: state
      entity_id: switch.tasmota_2
  condition:
    - condition: template
      value_template: "{{ states('sensor.energy_price_total') | float(0) < states('input_number.low_energy_price_cap') | float(0.10) }}"
    - condition: state
      entity_id: light.sonoff
      state: "off"
    - condition: template
      value_template: >
        {% set total_limit = 17000.0 %}
        {% set current_consumption = states('sensor.l3_current') | float(0) %}
        {% set water_heater_current = 10000.0 %}
        {% set available_current = total_limit - current_consumption %}
        {{ available_current >= water_heater_current }}
  action:
    - service: light.turn_on
      target:
        entity_id: light.sonoff
    - service: logbook.log
      data:
        name: Water Heater
        message: >
          Turned ON - Price: {{ states('sensor.energy_price_total') | round(3) }} €/kWh,
          Available current: {{ ((17000.0 - states('sensor.l3_current') | float(0)) / 1000) | round(2) }} A
        entity_id: light.sonoff
  mode: single

# Automation: Water Heater - Turn OFF when price rises above low_energy_price_cap
- id: water_heater_turn_off_before_price_rise
  alias: "Water Heater - Turn OFF before price rises above low_energy_price_cap"
  description: "Turns off water heater 0.5 minutes before price rises above low energy price cap"
  trigger:
    - platform: state
      entity_id: sensor.energy_price_total
    - platform: state
      entity_id: input_number.low_energy_price_cap
    - platform: time_pattern
      minutes: "/5"
    - platform: state
      entity_id: sensor.combined_nordpool_prices_with_transfer
      attribute: data
  condition:
    - condition: state
      entity_id: light.sonoff
      state: "on"
    - condition: or
      conditions:
        # Condition 1: Price is already at or above low_energy_price_cap
        - condition: template
          value_template: "{{ states('sensor.energy_price_total') | float(0) >= (states('input_number.low_energy_price_cap') | float(0.10)) - 0.001 }}"
        # Condition 2: Price will rise above low_energy_price_cap within 0.5 minutes
        - condition: template
          value_template: >
            {% set price_cap = states('input_number.low_energy_price_cap') | float(0.10) %}
            {% set price_data = state_attr('sensor.combined_nordpool_prices_with_transfer', 'data') %}
            {% if price_data is iterable and price_data is not string %}
              {% set now_ts = now().timestamp() %}
              {% set check_time = now_ts + 30 %}
              {% set current_price = none %}
              {% set next_price = none %}
              {% for price_entry in price_data %}
                {% set start_ts = price_entry.start_time | as_datetime | as_local | as_timestamp %}
                {% set end_ts = price_entry.end_time | as_datetime | as_local | as_timestamp %}
                {% if now_ts >= start_ts and now_ts < end_ts %}
                  {% set current_price = price_entry.price_per_kwh %}
                {% elif start_ts > now_ts and start_ts <= check_time %}
                  {% if next_price is none or start_ts < (next_price.start_time | as_datetime | as_local | as_timestamp) %}
                    {% set next_price = price_entry %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% if current_price is not none and current_price < price_cap %}
                {% if next_price is not none and next_price.price_per_kwh >= price_cap %}
                  {% set next_start = next_price.start_time | as_datetime | as_local | as_timestamp %}
                  {% set time_until = next_start - now_ts %}
                  {{ time_until <= 30 and time_until > 0 }}
                {% else %}
                  false
                {% endif %}
              {% else %}
                false
              {% endif %}
            {% else %}
              false
            {% endif %}
  action:
    - service: light.turn_off
      target:
        entity_id: light.sonoff
    - service: logbook.log
      data:
        name: Water Heater
        message: >
          {% set price_cap = states('input_number.low_energy_price_cap') | float(0.10) %}
          {% set price_data = state_attr('sensor.combined_nordpool_prices_with_transfer', 'data') %}
          {% set now_ts = now().timestamp() %}
          {% set current_price = none %}
          {% if price_data is iterable and price_data is not string %}
            {% for price_entry in price_data %}
              {% set start_ts = price_entry.start_time | as_datetime | as_local | as_timestamp %}
              {% set end_ts = price_entry.end_time | as_datetime | as_local | as_timestamp %}
              {% if now_ts >= start_ts and now_ts < end_ts %}
                {% set current_price = price_entry.price_per_kwh %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if current_price is not none and current_price >= price_cap %}
            Turned OFF - Price is {{ current_price | round(3) }} €/kWh (at or above {{ price_cap }} €/kWh)
          {% else %}
            Turned OFF - Price will rise above {{ price_cap }} €/kWh within 0.5 minutes
          {% endif %}
        entity_id: light.sonoff
  mode: single

